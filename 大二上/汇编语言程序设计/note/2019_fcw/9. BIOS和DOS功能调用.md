---
title: 9——BIOS和DOS功能调用
top: false
cover: false
toc: true
mathjax: true
date: 2021-01-07 20:01:06
password:
summary:
tags: "汇编"
categories: "汇编复习简纲"
---

# 第九讲 BIOS 和 DOS 功能调用

## 一 BIOS 和 DOS 简介

BIOS/DOS 的每一个功能对应着一个中断服务程序，BIOS/DOS 中断属于软件中断，其中 5-1FH 号中断为 BIOS 中断，20H-3FH 号中断为 DOS 中断，剩余 40-FFH 号中断为自由中断。

IBM PC 机在只读存储器 ROM 中固化的一组软件，形成 PC 机基本输入输出系统，称为 ROM BIOS，其包括以下功能：

* 系统自检及初始化
* 系统服务
* 硬件中断处理

![CPU中断、8259A中断、BIOS中断](.\img\image-20210107152643992.png)

磁盘操作系统（Disk Operation System）是早起 PC 机重要操作系统之一，主要包括三个模块：

* IBMBIO.COM：DOS 与 ROM BIOS 的接口
* IBMDOS.COM：在 IBMBIO.COM 基础上的文件管理程序和处理程序
* COMMAND.COM：DOS 的命令处理程序

![DOS功能](.\img\image-20210107152558120.png)

## 二 键盘 I/O 

### 1、字符码与扫描码

键盘可以得到按键的位置，并以位置为扫描码，通过8位数据线送往主机。当 “按下” 或 “松开” 一个键时，若允许中断，会产生一个 9 号中断。该中断会从 8259A 芯片中读取一个扫描码，低7位为扫描码，最高位 0/1 表示按下或断开。随后生成 ASCII 码，或指定操作。转换得到的字符码和扫描码存储于 BIOS 数据区的键盘缓冲区中。随后可以使用 BIOS 16H 号功能或 DOS 21H 号从队列中取出字符码和扫描码进行处理。

### 2、BIOS 键盘中断（16H）

| 中断号 | 寄存器参数 | 功能                                                         |
| ------ | ---------- | ------------------------------------------------------------ |
| 16H    | AH=0       | 从键盘读字符<br />AL=字符码，AH=扫描码                       |
| 16H    | AH=1       | 从<u>键盘缓冲区</u>读字符<br />ZF=0，AL=字符码，AH=扫描码<br />ZF=1，表示缓冲区为空 |
| 16H    | AH=2       | AL=键盘状态字节                                              |

当按下控制键、双态键或特殊请求键时，其扫描码不会加入缓冲区中，而是通过键盘状态字节进行记录

<img src=".\img\image-20210107154331600.png" alt="键盘状态字节" style="zoom: 50%;" />

### 3、DOS 键盘功能调用（21H）

| AH   | 功能                                          | 调用参数           | 返回参数                                          |
| ---- | --------------------------------------------- | ------------------ | ------------------------------------------------- |
| 1    | 从键盘中输入一个字符并显示在屏幕上            |                    | AL=字符码                                         |
| 6    | 从键盘缓冲区中读取键盘字符码                  | DL=0FFH            | 若有字符可取，AL=字符码，ZF=0<br />否则AL=0，ZF=1 |
| 7    | 从键盘中输入一个字符并不显示                  |                    | AL=字符码                                         |
| 8    | 从键盘中输入一个字符并不显示，检测 ctrl+break |                    | AL=字符码                                         |
| A    | 读取一串字符到缓冲区                          | DS:DX=缓冲区首地址 |                                                   |
| B    | 读取键盘状态                                  |                    | 若有键入，AL=0FFH<br />否则AL=0                   |
| C    | 清除键盘缓冲区并调用一种键盘功能              | AL=键盘功能号      | 依键盘功能号而定                                  |

注，输入字符串的缓冲区定义方式

```assembly
datas segment
	smax db 21			; 缓冲区首址，存储最大字符数（包括回车）
	sact db ?			; 存储实际输入字符数
	stri db 21 dup (?)	; 存储真正输入的字符
datas ends
```

### 三 显示器 I/O

### 1、字符属性

文本显示模式下，屏幕被划分为 25$\times$80，左上角坐标为（0,0），右下角坐标为（24,79）。字符以矩形块在屏幕上显示，主要显示字符集大小有 $8\times8$、$8\times14$、$8\times16$。

屏幕上每个位置对应于主存中的一段空间，存储器中一个字（高字节属性、低字节字符码）表示屏幕中对应位置的一个字符。单色显示适配器 MDA 显存起始地址为 B000:0000，CGA、VGA、EGA 显存起始地址为 B800:0000。对于 VGA，其 0，1,2,3 页的起始地址分别为 B800:0000,B800:1000,B800:2000,B800:3000。

![字符属性](.\img\image-20210107171859140.png)

### 2、BIOS 显示中断调用（10H）

| AH   | 功能                         | 调用参数                                                     | 返回参数                              |
| ---- | ---------------------------- | ------------------------------------------------------------ | ------------------------------------- |
| 1    | 设置光标类型                 | CH=光标开始行<br />CL=光标结束行                             | 无                                    |
| 2    | 设置光标位置                 | BH=页号，DH=行号，DL=列号                                    | 无                                    |
| 3    | 读出当前光标位置             | BH=页号                                                      | DH=行号<br />DL=列号<br />CX=光标大小 |
| 6    | 初始窗口或窗口上滚           | AL=上滚行数<br />CX=左上角行、列号<br />DX=右下角行、列号<br />BH=空白行的属性 | 无                                    |
| 7    | 初始窗口或窗口下滚           | AL=下滚行数<br />CX=左上角行、列号<br />DX=右下角行、列号<br />BH=空白行的属性 | 无                                    |
| 8    | 读取当前光标位置的字符和属性 | BH=页号                                                      | AH=字符码<br />BL=字符属性            |
| 9    | 在当前光标位置写字符和属性   | BH=页号<br />AL=字符码<br />BL=字符属性<br />CX=写入字符重复次数 | 无                                    |

### 3、DOS 显示功能调用

| AH   | 功能                           | 调用参数                     | 返回参数 |
| ---- | ------------------------------ | ---------------------------- | -------- |
| 2    | 显示一个字符（检查Ctrl+Break） | DL=字符，光标跟随移动        | 无       |
| 6    | 显示一个字符（不检查CB）       | DL=字符，光标跟随移动        | 无       |
| 9    | 显示字符串                     | DS:DX=串地址，必须以"\$"结尾 | 无       |

## 四 串行通信口 I/O

并行通信：多位数据通过多条数据线同时传送
串行通信：多位数据通过同一条数据线传送
通信方式：单工、半双工、全双工

串行通信又分为两种类型：同步通信和异步通信。异步通信每个字符单独传输，而同步通信每个字符连接成数据块（信息帧）进行传输。

![异步通信](.\img\image-20210107190702509.png)

![同步通信](.\img\image-20210107190833365.png)

波特率：指计算机中每秒传送数据的位数

使用 DOS 命令可以设置串行通信参数：波特率、校验位、字长和终止位
格式：`MODE COMm:b, p, d, s`。其中 `b` 指波特率，用波特率的最高两位来表示；`p` 指校验位，`n/o/e` 分别表示无校验、奇校验、偶校验；`d` 指数据的字长；`s` 指终止位位数，可以为1、1.5或2

**DOS串行通信功能调用**

| AH   | 功能             | 调用参数      | 返回参数      |
| ---- | ---------------- | ------------- | ------------- |
| 3    | 从串行口读取字符 |               | AL=输入的数据 |
| 4    | 向串行口写入字符 | DL=输出的数据 |               |

## 五 文件 I/O

文件操作可以使用 BIOS 的INT 13H，或 DOS 的INT 21H，只介绍 DOS 提供的文件操作。

### 1、预备知识

#### （1）路径名和 ASCIZ 串

asciz 串是一个关于文件位置的字符串，但其最后一个字节必须为 0，可定义成如下形式

```assembly
filename db 'd:\test\a.txt', 00
```

DOS 得到文件路径名之后，会得到一个文件代号用来唯一的表示文件。其中 0-4 的文件代号已固定，且长期处于打开状态。最多同时打开 5 个文件。

#### （2）错误返回码

对文件进行操作得到的返回参数中，CF=0 表示操作成功，CF=1 表示操作失败。而错误类型码保存在 AX 寄存器中。

![错误类型码](.\img\image-20210107192719130.png)

#### （3）文件属性

每个文件都拥有自己的属性，使用字节表示，存放在 CX 寄存器中

![文件属性字节](.\img\image-20210107194158430.png)

其中常用的有普通文件（00H），只读文件（01H），隐藏文件（02H），只读隐藏系统文件（07H）

#### （4）文件指针

文件指针用来指示当前在文件中的位置，其实一个 32 位二进制数，建立或打开文件后文件指针初值为 0，且每次文件指针的移动位移量等于读写文件的字节数。

### 2、常用文件处理命令

| AH   | 功能         | 入口参数                                               | 出口参数                                                     |
| ---- | ------------ | ------------------------------------------------------ | ------------------------------------------------------------ |
| 3CH  | 建立文件     | CX=文件属性  DS：DX=文件说明地址                       | CF=0，调用成功，AX=文件代号  CF=1，调用失败，AX=错误代码     |
| 3DH  | 打开文件     | AL=存取代码  DS：DX=文件说明地址                       | CF=0，调用成功，AX=文件代号  CF=1，调用失败，AX=错误代码     |
| 3EH  | 关闭文件     | BX=文件代号                                            | CF=0，调用成功  CF=1，调用失败，AX=错误代码                  |
| 3FH  | 读文件       | BX=文件代号  CX=读文件的字节数  DS：DX=文件缓冲区地址  | CF=0，调用成功，AX=实际读入的字节数  CF=1，调用失败，AX=错误代码 |
| 40H  | 写文件       | BX=文件代号  CX=写文件的字节数  DS：DX=文件缓冲区地址  | CF=0，调用成功，AX=实际写入的字节数  CF=1，调用失败，AX=错误代码 |
| 42H  | 移动文件指针 | BX=文件代号  AL=移动方式  CX：DX=移动字节数            | CF=0，调用成功，DX：AX=指针新位置  CF=1，调用失败，AX=错误代码 |
| 43H  | 读写文件属性 | AL=0检验/1置文件属性  CX=文件属性  DS：DX=文件说明地址 | CF=0，调用成功，AX=文件属性  CF=1，调用失败，AX=错误代码     |

![文件存取代码](.\img\image-20210107195124137.png)

![其他操作](.\img\image-20210107195505397.png)



复习完结撒花 \\（^ v ^）/\*\*\*