---
title: 7——宏
top: false
cover: false
toc: true
mathjax: true
date: 2021-01-06 15:42:41
password:
summary:
tags: "汇编"
categories: "汇编复习简纲"
---

# 第七讲 宏

## 一 宏

宏的使用有两部分，一部分为宏定义，宏定义中宏体为主要内容，另一部分为宏调用。汇编时，宏定义消失，宏调用（宏指令）由宏体取代。在宏定义或宏调用语句中，存在具有特殊功能的操作符可供调用。为解决标号问题，提出了 `local` 宏指令。与子程序类似，宏也存在嵌套问题，需注意相关规范。宏与子程序都辅助人们更好的编写程序，但是各有侧重。

### 1、宏定义：

```assembly
MacroName macro [params]
	...
	endm
```

* 宏体是由指令、伪指令以及宏指令构成的程序段。
* 实参和形参的数目可以不同，若实参多于形参，则多余参数被忽略，若实参少于形参，则对应形参被置空。
* 宏定义需置于宏调用之前的任何位置。
* 实参可以为任意字符。
* 汇编程序会对源代码进行宏展开，即用相应宏体代替宏指令，并用实参代替宏体中的形参。因此应保证实参代替形参后，宏体中语句仍有效。

### 2、相关操作符

* 连接操作符 `&`

    在宏体中，使用连接操作符 `&` 作为形参的前缀，在宏展开时 `&` 前后的两个符号会连接。其也可作为形参的后缀。

* 表达式操作符 `%`

    在宏调用时，若实参为表达式，该操作符可用于表达式之前，强迫表达式立即求值，并将结果作为实参。

* 转义操作符 `!`

    用于宏调用的实参之前，表示使用其后紧邻字符的本义。

* `LOCAL` 伪指令

    ```assembly
    MName macro [params list]
    	local [label list]
    label1:
    label2:
    	...
    endm
    ```

    标号表中各标号使用逗号分隔。`local` 伪操作仅用于宏定义中，其必须紧邻 `macro` 伪指令之后，中间不得有注释以及分号。处理宏调用时，汇编程序将用 ??0000、??0001 等来代替标号。

    

### 3、宏嵌套

宏嵌套有两种形式，其一为宏体中包括宏定义，其二是宏体中包括宏调用，此时其调用的宏指令必须已经定义完成。

### 4、宏定义与子程序的区别

* 处理时间：宏调用在汇编时由汇编程序处理，而子程序调用则由CPU执行
* 处理方式：宏定义实质上是对源代码的文本替换，而子程序是CS：IP地址的转换
* 参数处理：宏调用采用字符串进行传参，而子程序需要借助寄存器或内存
* 执行速度：子程序需要调用call和ret指令以及传参操作，相比宏调用稍慢
* 占用空间：宏指令由于会出现多次文本替换，因此其占用内存空间较大，而子程序代码仅会出现一次，因此占用空间小

宏是源程序级的简化，子程序是目标程序级的简化。模块化结构设计时多采用子程序，而非标准程序段且代码量小、调用次数少，或功能明确的代码可采用宏。

## 二 重复汇编

重复汇编用于生成连续且完全相同或几乎完全相同的一组代码。

#### 1、rept

```assembly
rept 整数表达式
	重复体
endm
```

重复重复体 n 次，n 为整数表达式的值。

应用

```assembly
x = 0
rept 10
	x = x + 1
	db x
endm
```

#### 2、irp

```assembly
irp 形参, <实参列表>
	重复体
endm
```

重复重复体，依次取实参列表中的实参代替重复体中的形参。

应用

```assembly
irp x, <ax, bx, cx, cx>
	push x
endm
```

#### 3、irpc

```assembly
irpc 形参, 字符串
	重复体
endm
```

重复重复体，依次取字符串中的字符取代重复体中形参。

应用

```assembly
irpc x, 0123456789
	db x
endm
```

### 三 库的使用

宏库扩展名为 "\*.mac"，可以使用 `include` 伪指令来引用宏库，调用格式为 `include [文件路径]`。可以使用 `purge` 语句取消宏定义，形如 `purge mName1, mName2, ...`。

宏指令名可以与指令或伪指令同名，且宏指令名优先级更高。同样的，可以使用 `purge` 在某一位置之后清除已定义的宏。
